<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gráfico de Rehabilitación de Vía</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #plot {
            width: 90%;
            margin: auto;
            height: 800px;
        }
        #selector {
            width: 300px;
            margin: 20px auto;
            display: flex;
            justify-content: center;
        }
    </style>
</head>
<body>
    <h1>Gráfico de Rehabilitación de Vía</h1>
    <div id="selector">
        <label for="tramSelector">Seleccione el Tramo: </label>
        <select id="tramSelector"></select>
    </div>
    <div id="plot"></div>

    <script>
        async function loadData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                console.log(`Datos cargados de ${url}:`, data); // Mostrar datos cargados
                return data;
            } catch (error) {
                console.error(`Error cargando datos de ${url}:`, error);
            }
        }

        async function drawPlot(tram) {
            const resumUrl = 'https://raw.githubusercontent.com/cvazquezfgc/planificacio-renovacio-via/main/resum.json';
            const resumData = await loadData(resumUrl);

            // Verificar si los datos están cargados correctamente
            if (!resumData) {
                console.error('Los datos no pudieron ser cargados.');
                return;
            }

            // Imprimir un ejemplo de los datos cargados para verificar los campos
            console.log('Ejemplo de datos cargados:', resumData[0]);

            // Filtrar los datos específicos para el tramo seleccionado (sin normalización)
            console.log(`Tramo seleccionado: ${tram}`);
            const via1 = resumData.filter(d => d.Via === 1 && d.TRAM === tram);
            const via2 = resumData.filter(d => d.Via === 2 && d.TRAM === tram);

            console.log(`Datos filtrados para el tramo ${tram}: Vía 1:`, via1);
            console.log(`Datos filtrados para el tramo ${tram}: Vía 2:`, via2);

            if (via1.length === 0 && via2.length === 0) {
                console.error(`No se encontraron datos para el tramo ${tram}.`);
                Plotly.newPlot('plot', [], { title: `No hay datos disponibles para el tramo ${tram}` });
                return;
            }

            // Crear datos de ejemplo simplificados para la visualización
            const traceVia1 = {
                x: via1.map(d => d['PREVISIÓ REHABILITACIÓ']),
                y: via1.map(d => d['PK final'] - d['PK inici']),
                base: via1.map(d => d['PK inici']),
                type: 'bar',
                name: 'Vía 1',
                orientation: 'v'
            };

            const traceVia2 = {
                x: via2.map(d => d['PREVISIÓ REHABILITACIÓ']),
                y: via2.map(d => d['PK final'] - d['PK inici']),
                base: via2.map(d => d['PK inici']),
                type: 'bar',
                name: 'Vía 2',
                orientation: 'v'
            };

            // Configuración simple para el gráfico
            const layout = {
                title: `Espai-temps previsió rehabilitació del tram ${tram}`,
                xaxis: {
                    title: 'Any previsió rehabilitació',
                    tickangle: -45
                },
                yaxis: {
                    title: 'PK'
                },
                showlegend: true
            };

            // Dibujar la gráfica con los datos simplificados
            Plotly.newPlot('plot', [traceVia1, traceVia2], layout);
        }

        // Llenar el selector de tramo y agregar evento
        async function init() {
            const resumUrl = 'https://raw.githubusercontent.com/cvazquezfgc/planificacio-renovacio-via/main/resum.json';
            const resumData = await loadData(resumUrl);
            const tramSelector = document.getElementById('tramSelector');

            if (!resumData) {
                console.error('Error al cargar los datos para llenar el selector.');
                return;
            }

            // Obtener todos los tramos únicos sin normalizar
            const trams = [...new Set(resumData.map(d => d.TRAM))];

            // Añadir opciones al selector
            trams.forEach(tram => {
                if (tram) {
                    const option = document.createElement('option');
                    option.value = tram;
                    option.textContent = tram;
                    tramSelector.appendChild(option);
                }
            });

            // Agregar evento al selector para dibujar el gráfico del tramo seleccionado
            tramSelector.addEventListener('change', (e) => {
                drawPlot(e.target.value);
            });

            // Dibujar el gráfico inicialmente para el primer tramo
            if (trams.length > 0) {
                drawPlot(trams[0]);
            } else {
                console.error('No se encontraron tramos disponibles en los datos.');
            }
        }

        // Inicializar la página
        init();
    </script>
</body>
</html>
